<!DOCTYPE html>
<html xmlns:th="https://thymeleaf.org">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caixa de Mensagens | WinPost</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/css/estilo.css">

<style>
    body { background-color: #f6f8fc; }
    
    /* Ícones e Ações */
    .action-icon { cursor: pointer; color: #ccc; transition: transform 0.2s, color 0.2s; padding: 5px; }
    .action-icon:hover { transform: scale(1.2); }
    .star-active { color: #f4b400; }
    .flag-active { color: #0b57d0; }
    
    /* Menu Lateral */
    .nav-link-custom.active { background-color: #d3e3fd; color: #001d35; font-weight: 700; border-radius: 0 24px 24px 0; }
    .nav-link-custom { color: #444746; font-weight: 500; padding: 10px 16px; border-radius: 0 24px 24px 0; display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px;}
    .nav-link-custom:hover { background-color: #e1e5ea; }
    .menu-badge { font-size: 0.75rem; font-weight: 600; }
    
    /* Tabela */
    .table-hover tbody tr:hover { background-color: #f2f6fc; }
    .row-clickable { cursor: pointer; }
    
    /* Chip de Anexo na Lista */
    .badge-attachment { background-color: #f1f3f4; color: #5f6368; border: 1px solid #dadce0; font-weight: 400; font-size: 0.75rem; }

    /* Chip de Download no Modal */
    .attachment-chip {
        display: inline-flex;
        align-items: center;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 8px 12px;
        margin-right: 10px;
        margin-bottom: 10px;
        text-decoration: none;
        color: #333;
        transition: all 0.2s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .attachment-chip:hover {
        background-color: #f8f9fa;
        border-color: #0d6efd;
        color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
</head>

<body class="d-flex flex-column min-vh-100">

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="flex-grow-1">
        <div style="margin-top: 80px;"></div>

        <div class="container-fluid px-0 px-lg-4 mb-5">
            <div class="row g-0 g-lg-4">
                
                <div class="col-lg-3 col-xl-2 d-none d-lg-block pt-2">
                    <div class="d-grid pe-4 mb-4">
                        <a href="/grupos/gerenciar" class="btn btn-primary rounded-4 fw-bold py-3" style="background-color: #c2e7ff; color: #001d35; border: none;">
                            <i class="fa-solid fa-pen me-2"></i>Escrever
                        </a>
                    </div>
                    
                    <nav class="nav flex-column pe-2">
                        <a href="/mensagens/caixa/ENTRADA" class="nav-link-custom" th:classappend="${pastaAtiva == 'ENTRADA'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-solid fa-inbox me-3"></i> Entrada</div>
                            <span class="menu-badge" th:if="${cntEntrada > 0}" th:text="${cntEntrada}"></span>
                        </a>
                        <a href="/mensagens/caixa/ENVIADAS" class="nav-link-custom" th:classappend="${pastaAtiva == 'ENVIADAS'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-regular fa-paper-plane me-3"></i> Enviadas</div>
                            <span class="menu-badge" th:if="${cntEnviadas > 0}" th:text="${cntEnviadas}"></span>
                        </a>
                        <a href="/mensagens/caixa/FAVORITOS" class="nav-link-custom" th:classappend="${pastaAtiva == 'FAVORITOS'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-regular fa-star me-3"></i> Favoritos</div>
                            <span class="menu-badge" th:if="${cntFavoritos > 0}" th:text="${cntFavoritos}"></span>
                        </a>
                        <a href="/mensagens/caixa/IMPORTANTE" class="nav-link-custom" th:classappend="${pastaAtiva == 'IMPORTANTE'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-solid fa-bookmark me-3"></i> Importante</div>
                            <span class="menu-badge" th:if="${cntImportante > 0}" th:text="${cntImportante}"></span>
                        </a>
                        <a href="/mensagens/caixa/LIXEIRA" class="nav-link-custom" th:classappend="${pastaAtiva == 'LIXEIRA'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-regular fa-trash-can me-3"></i> Lixeira</div>
                            <span class="menu-badge" th:if="${cntLixeira > 0}" th:text="${cntLixeira}"></span>
                        </a>
                    </nav>
                </div>

                <div class="col-lg-9 col-xl-10">
                    <div class="d-flex justify-content-between align-items-center mb-3 px-3 px-lg-0">
                        <h4 class="fw-bold text-dark mb-0 text-capitalize">
                            <i th:if="${pastaAtiva == 'LIXEIRA'}" class="fa-regular fa-trash-can me-2 text-danger"></i>
                            <span th:text="${pastaAtiva == 'ENVIADAS' ? 'Enviadas' : (pastaAtiva == 'LIXEIRA' ? 'Lixeira' : pastaAtiva)}">Caixa</span>
                        </h4>
                        
                        <div th:if="${pastaAtiva == 'LIXEIRA'}" class="ms-auto me-3">
                            <small class="text-danger fw-bold"><i class="fa-solid fa-circle-info me-1"></i>30 dias para exclusão automática</small>
                        </div>

                        <div class="input-group" style="max-width: 300px;">
                            <span class="input-group-text bg-white border-0 rounded-start-pill ps-3"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                            <input type="text" class="form-control border-0 rounded-end-pill shadow-sm" placeholder="Pesquisar...">
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <tbody>
                                    <tr th:each="msg : ${listaMensagens}" class="row-clickable" th:onclick="'verMensagem(' + ${msg.id} + ')'">
                                        
                                        <td class="ps-4" style="width: 80px;" onclick="event.stopPropagation()">
                                            <div class="d-flex gap-2" th:classappend="${pastaAtiva == 'LIXEIRA'} ? 'opacity-25' : ''">
                                                <i class="fa-star action-icon" 
                                                   th:classappend="${msg.favorito} ? 'fa-solid star-active' : 'fa-regular'"
                                                   th:onclick="${pastaAtiva != 'LIXEIRA'} ? 'toggleAction(' + ${msg.id} + ', \'favoritar\', this, \'star\')' : ''"></i>
                                                
                                                <i class="fa-bookmark action-icon"
                                                   th:classappend="${msg.importante} ? 'fa-solid flag-active' : 'fa-regular'"
                                                   th:onclick="${pastaAtiva != 'LIXEIRA'} ? 'toggleAction(' + ${msg.id} + ', \'importante\', this, \'flag\')' : ''"></i>
                                            </div>
                                        </td>

                                        <td style="width: 20%;">
                                            <span class="fw-bold text-dark" th:text="${msg.nomeGrupoDestino}">Grupo</span>
                                        </td>

                                        <td>
                                            <div class="text-truncate" style="max-width: 500px;">
                                                <span class="fw-bold text-dark" th:text="${msg.assunto}">Assunto</span>
                                                <span th:if="${msg.nomesAnexos != null && msg.nomesAnexos != ''}" class="badge badge-attachment ms-2">
                                                    <i class="fa-solid fa-paperclip me-1"></i> anexo
                                                </span>
                                                <span class="text-muted small ms-2" th:text="${#strings.abbreviate(msg.conteudo.replaceAll('<[^>]*>', ''), 60)}">Conteúdo...</span>
                                            </div>
                                        </td>

                                        <td style="width: 100px;" class="text-end pe-3" onclick="event.stopPropagation()">
                                            <button th:if="${pastaAtiva != 'LIXEIRA'}" 
                                                    class="btn btn-light btn-sm rounded-circle text-muted hover-danger" 
                                                    th:onclick="'abrirModalLixeira(' + ${msg.id} + ')'" title="Mover para Lixeira">
                                                <i class="fa-regular fa-trash-can"></i>
                                            </button>

                                            <div th:if="${pastaAtiva == 'LIXEIRA'}" class="d-flex justify-content-end gap-2">
                                                <button class="btn btn-light btn-sm rounded-circle text-success" 
                                                        th:onclick="'restaurarMensagem(' + ${msg.id} + ')'" title="Restaurar">
                                                    <i class="fa-solid fa-trash-arrow-up"></i>
                                                </button>
                                                <button class="btn btn-light btn-sm rounded-circle text-danger" 
                                                        th:onclick="'abrirModalExclusaoDefinitiva(' + ${msg.id} + ')'" title="Excluir Definitivamente">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                        </td>

                                        <td class="pe-4 text-end" style="width: 100px;">
                                            <span class="small fw-bold text-muted" th:text="${#temporals.format(msg.dataEnvio, 'dd MMM')}">Data</span>
                                        </td>
                                    </tr>
                                    
                                    <tr th:if="${#lists.isEmpty(listaMensagens)}">
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <p th:text="${pastaAtiva == 'LIXEIRA'} ? 'Lixeira vazia.' : 'Nenhuma mensagem.'">Vazio</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalLeitura" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modal-content-custom shadow-lg">
            
            <div class="modal-header-custom d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="avatar-initial me-3 shadow-sm" id="modalAvatar">W</div>
                    <div>
                        <h5 class="fw-bold mb-0 text-dark" id="modalAssunto">Assunto da Mensagem</h5>
                        <small class="text-muted"><i class="fa-regular fa-calendar-check me-1"></i> <span id="modalData">27/01/2026</span></small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm rounded-pill px-3 border-0" onclick="window.print()"><i class="fa-solid fa-print"></i></button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>

            <div class="modal-body p-4 bg-light bg-opacity-50">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="small text-uppercase text-muted fw-bold mb-1">Enviado para</label>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-white text-primary border rounded-pill px-3 py-2 shadow-sm">
                                <i class="fa-solid fa-users me-2"></i> <span id="modalGrupo">Grupo de Teste</span>
                            </span>
                        </div>
                    </div>
                    
                </div>

                <div class="message-container shadow-sm mb-4" id="modalConteudo">
                    </div>

                <div id="areaAnexosModal" class="d-none">
                    <h6 class="fw-bold text-dark mb-3"><i class="fa-solid fa-paperclip me-2 text-primary"></i>Arquivos em anexo</h6>
                    <div id="listaAnexosDownload" class="d-flex flex-wrap gap-3">
                        </div>
                </div>
            </div>

            <div class="modal-footer border-0 p-3 bg-light">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Fechar Visualização</button>
            </div>
        </div>
    </div>
</div>
    <div class="modal fade" id="modalLixeira" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center">
                <div class="modal-body p-4">
                    <div class="mb-3 text-dark bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="fa-regular fa-trash-can fa-2x"></i></div>
                    <h5 class="fw-bold mb-3">Mover para a Lixeira?</h5>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">Não</button>
                        <button type="button" class="btn btn-warning rounded-pill px-3 fw-bold" id="btnConfirmarLixeira">Sim</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalExclusaoDefinitiva" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center">
                <div class="modal-body p-4">
                    <div class="mb-3 text-danger bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="fa-solid fa-triangle-exclamation fa-2x"></i></div>
                    <h5 class="fw-bold text-danger mb-1">Excluir Definitivamente?</h5>
                    <p class="small text-muted mb-3">Irreversível.</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger rounded-pill px-3 fw-bold" id="btnConfirmarExclusaoDefinitiva">Excluir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let idSelecionado = null;
        
        function abrirModalLixeira(id) { idSelecionado = id; new bootstrap.Modal(document.getElementById('modalLixeira')).show(); }
        
        document.getElementById('btnConfirmarLixeira').addEventListener('click', () => { 
            if(idSelecionado) $.post('/mensagens/lixeira/' + idSelecionado, () => location.reload()); 
        });
        
        function restaurarMensagem(id) { $.post('/mensagens/restaurar/' + id, () => location.reload()); }
        
        function abrirModalExclusaoDefinitiva(id) { 
            idSelecionado = id; 
            new bootstrap.Modal(document.getElementById('modalExclusaoDefinitiva')).show(); 
        }
        
        document.getElementById('btnConfirmarExclusaoDefinitiva').addEventListener('click', () => { 
            if(idSelecionado) { 
                $.ajax({ url: '/mensagens/excluir/' + idSelecionado, type: 'DELETE', success: () => location.reload() }); 
            } 
        });
        
        function toggleAction(id, action, element, type) {
            $.post('/mensagens/' + action + '/' + id, function(state) {
                if(type === 'star') $(element).toggleClass('fa-solid star-active fa-regular');
                if(type === 'flag') $(element).toggleClass('fa-solid flag-active fa-regular');
            });
        }

        function verMensagem(id) {
            const modal = new bootstrap.Modal(document.getElementById('modalLeitura'));
            
            $.get("/mensagens/detalhes/" + id, function(data) {
                // Preenche os textos
                $('#modalAssunto').text(data.assunto);
                $('#modalConteudo').html(data.conteudo);
                $('#modalGrupo').text(data.nomeGrupoDestino);
                $('#modalStatus').text(data.status || 'ENVIADO');
                
                // Letra inicial do Avatar
                $('#modalAvatar').text(data.nomeGrupoDestino.charAt(0).toUpperCase());

                // Data formatada (Ex: 27 de Jan às 14:00)
                const dt = new Date(data.dataEnvio);
                const dataFormatada = dt.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }) + ' às ' + 
                                      dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                $('#modalData').text(dataFormatada);

                // Lógica de Anexos
                const areaAnexos = $('#areaAnexosModal');
                const listaAnexos = $('#listaAnexosDownload');
                listaAnexos.empty(); 

                if (data.nomesAnexos && data.nomesAnexos.trim() !== '') {
                    areaAnexos.removeClass('d-none');
                    const arquivos = data.nomesAnexos.split(',');
                    
                    arquivos.forEach(arquivo => {
                        const nomeFisico = arquivo.trim();
                        if(!nomeFisico) return;
                        
                        const nomeExibicao = nomeFisico.includes('_') ? nomeFisico.substring(nomeFisico.indexOf('_') + 1) : nomeFisico;
                        
                        // Determina o ícone baseado na extensão
                        let icon = 'fa-file-lines';
                        if(nomeExibicao.toLowerCase().endsWith('.pdf')) icon = 'fa-file-pdf text-danger';
                        if(nomeExibicao.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/)) icon = 'fa-file-image text-success';

                        const cardHtml = `
                            <a href="/uploads/${nomeFisico}" download="${nomeExibicao}" target="_blank" class="attachment-card shadow-sm">
                                <div class="me-3 fs-4"><i class="fa-solid ${icon}"></i></div>
                                <div class="text-truncate" style="max-width: 180px;">
                                    <div class="text-dark fw-bold small text-truncate">${nomeExibicao}</div>
                                    <div class="text-muted tiny" style="font-size: 0.7rem;">Download</div>
                                </div>
                            </a>`;
                        
                        listaAnexos.append(cardHtml);
                    });
                } else {
                    areaAnexos.addClass('d-none');
                }
                
                modal.show();
            });
        }
    </script>
</body>
</html>