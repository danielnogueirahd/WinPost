<!DOCTYPE html>
<html xmlns:th="https://thymeleaf.org">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caixa de Mensagens | WinPost</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/css/estilo.css">
</head>

<body class="d-flex flex-column min-vh-100">

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="flex-grow-1 main-content-area">
        
        <div class="container-fluid px-2 px-lg-4 mb-5">
            
            <div class="d-lg-none mb-3">
                <div class="d-grid mb-3">
                    <a href="/grupos/gerenciar" class="btn btn-primary rounded-pill shadow-sm py-2">
                        <i class="fa-solid fa-pen me-2"></i>Escrever Nova Mensagem
                    </a>
                </div>
                
                <div class="mobile-nav-container">
                    <a href="/mensagens/caixa/ENTRADA" class="mobile-nav-link" th:classappend="${pastaAtiva == 'ENTRADA'} ? 'active'">
                        <i class="fa-solid fa-folder-open"></i>Modelos 
                        <span class="ms-1" th:if="${cntEntrada > 0}" th:text="'(' + ${cntEntrada} + ')'"></span>
                    </a>
                    <a href="/mensagens/caixa/ENVIADAS" class="mobile-nav-link" th:classappend="${pastaAtiva == 'ENVIADAS'} ? 'active'">
                        <i class="fa-regular fa-paper-plane"></i>Enviadas
                        <span class="ms-1" th:if="${cntEnviadas > 0}" th:text="'(' + ${cntEnviadas} + ')'"></span>
                    </a>
                    <a href="/mensagens/caixa/FAVORITOS" class="mobile-nav-link" th:classappend="${pastaAtiva == 'FAVORITOS'} ? 'active'">
                        <i class="fa-regular fa-star"></i>Favoritos
                        <span class="ms-1" th:if="${cntFavoritos > 0}" th:text="'(' + ${cntFavoritos} + ')'"></span>
                    </a>
                    <a href="/mensagens/caixa/IMPORTANTE" class="mobile-nav-link" th:classappend="${pastaAtiva == 'IMPORTANTE'} ? 'active'">
                        <i class="fa-solid fa-bookmark"></i>Importante
                        <span class="ms-1" th:if="${cntImportante > 0}" th:text="'(' + ${cntImportante} + ')'"></span>
                    </a>
                    <a href="/mensagens/caixa/LIXEIRA" class="mobile-nav-link" th:classappend="${pastaAtiva == 'LIXEIRA'} ? 'active'">
                        <i class="fa-regular fa-trash-can"></i>Lixeira
                        <span class="ms-1" th:if="${cntLixeira > 0}" th:text="'(' + ${cntLixeira} + ')'"></span>
                    </a>
                </div>
            </div>

            <div class="row g-0 g-lg-4">
                
                <div class="col-lg-3 col-xl-2 d-none d-lg-block pt-2">
                    <div class="d-grid pe-3 mb-4">
                        <a href="/grupos/gerenciar" class="btn btn-compose rounded-4 fw-bold py-3 shadow-sm text-start ps-4">
                            <i class="fa-solid fa-pen me-3"></i>Escrever
                        </a>
                    </div>
                    
                    <nav class="nav flex-column pe-2">
                        <a href="/mensagens/caixa/ENTRADA" class="nav-link-custom" th:classappend="${pastaAtiva == 'ENTRADA'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-solid fa-folder-open me-3" style="width: 20px;"></i> Modelos</div>
                            <span class="menu-badge" th:if="${cntEntrada > 0}" th:text="${cntEntrada}"></span>
                        </a>
                        <a href="/mensagens/caixa/ENVIADAS" class="nav-link-custom" th:classappend="${pastaAtiva == 'ENVIADAS'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-regular fa-paper-plane me-3" style="width: 20px;"></i> Enviadas</div>
                            <span class="menu-badge" th:if="${cntEnviadas > 0}" th:text="${cntEnviadas}"></span>
                        </a>
                        <a href="/mensagens/caixa/FAVORITOS" class="nav-link-custom" th:classappend="${pastaAtiva == 'FAVORITOS'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-regular fa-star me-3" style="width: 20px;"></i> Favoritos</div>
                            <span class="menu-badge" th:if="${cntFavoritos > 0}" th:text="${cntFavoritos}"></span>
                        </a>
                        <a href="/mensagens/caixa/IMPORTANTE" class="nav-link-custom" th:classappend="${pastaAtiva == 'IMPORTANTE'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-solid fa-bookmark me-3" style="width: 20px;"></i> Importante</div>
                            <span class="menu-badge" th:if="${cntImportante > 0}" th:text="${cntImportante}"></span>
                        </a>
                        <a href="/mensagens/caixa/LIXEIRA" class="nav-link-custom mt-3" th:classappend="${pastaAtiva == 'LIXEIRA'} ? 'active'">
                            <div class="d-flex align-items-center"><i class="fa-regular fa-trash-can me-3" style="width: 20px;"></i> Lixeira</div>
                            <span class="menu-badge" th:if="${cntLixeira > 0}" th:text="${cntLixeira}"></span>
                        </a>
                    </nav>
                </div>

                <div class="col-lg-9 col-xl-10">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 px-1">
                        <h4 class="fw-bold text-dark mb-3 mb-md-0 text-capitalize d-flex align-items-center">
                            <span th:if="${pastaAtiva == 'ENTRADA'}"><i class="fa-solid fa-swatchbook me-2 text-primary"></i>Meus Modelos</span>
                            <span th:unless="${pastaAtiva == 'ENTRADA'}">
                                <i th:if="${pastaAtiva == 'LIXEIRA'}" class="fa-regular fa-trash-can me-2 text-danger"></i>
                                <i th:if="${pastaAtiva == 'ENVIADAS'}" class="fa-regular fa-paper-plane me-2 text-success"></i>
                                <span th:text="${pastaAtiva == 'ENVIADAS' ? 'Enviadas' : (pastaAtiva == 'LIXEIRA' ? 'Lixeira' : pastaAtiva)}">Caixa</span>
                            </span>
                        </h4>
                        
                        <div class="d-flex align-items-center gap-2">
                            <div th:if="${pastaAtiva == 'ENTRADA'}" class="me-auto">
                                <button class="btn btn-sm btn-outline-primary rounded-pill fw-bold" onclick="abrirModalCriacao()">
                                    <i class="fa-solid fa-plus me-1"></i> Criar Novo
                                </button>
                            </div>

                            <div th:if="${pastaAtiva == 'LIXEIRA'}" class="me-3 d-none d-md-block">
                                <small class="text-danger fw-bold"><i class="fa-solid fa-circle-info me-1"></i>30 dias p/ exclusão</small>
                            </div>

                            <form th:action="@{'/mensagens/caixa/' + ${pastaAtiva}}" method="get" class="input-group" style="width: 100%; max-width: 300px;">
                                <span class="input-group-text bg-white border-0 rounded-start-pill ps-3"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                                <input type="text" name="busca" class="form-control border-0 rounded-end-pill shadow-sm" placeholder="Pesquisar..." th:value="${termoBusca}">
                            </form>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden" style="min-height: 400px;">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <tbody>
                                    <tr th:each="msg : ${listaMensagens}" class="row-clickable" th:onclick="'verMensagem(' + ${msg.id} + ')'">
                                        
                                        <td class="ps-3 ps-md-4" style="width: 60px;" onclick="event.stopPropagation()">
                                            <div class="d-flex gap-1 gap-md-2" th:classappend="${pastaAtiva == 'LIXEIRA'} ? 'opacity-25' : ''">
                                                <i class="fa-star action-icon" 
                                                   th:classappend="${msg.favorito} ? 'fa-solid star-active' : 'fa-regular'"
                                                   th:onclick="${pastaAtiva != 'LIXEIRA'} ? 'toggleAction(' + ${msg.id} + ', \'favoritar\', this, \'star\')' : ''"></i>
                                                
                                                <i class="fa-bookmark action-icon d-none d-md-inline"
                                                   th:classappend="${msg.importante} ? 'fa-solid flag-active' : 'fa-regular'"
                                                   th:onclick="${pastaAtiva != 'LIXEIRA'} ? 'toggleAction(' + ${msg.id} + ', \'importante\', this, \'flag\')' : ''"></i>
                                            </div>
                                        </td>

                                        <td style="width: 25%;" class="d-none d-md-table-cell">
                                            <span th:if="${pastaAtiva == 'ENTRADA'}" class="badge bg-light text-secondary border">
                                                <i class="fa-solid fa-tag me-1"></i> <span th:text="${msg.nomeGrupoDestino}">Categoria</span>
                                            </span>
                                            <span th:unless="${pastaAtiva == 'ENTRADA'}" class="fw-bold text-dark text-truncate d-block" style="max-width: 150px;" th:text="${msg.nomeGrupoDestino}">Grupo</span>
                                        </td>

                                        <td>
                                            <div class="d-flex flex-column">
                                                <small class="d-md-none text-muted fw-bold mb-1" th:text="${msg.nomeGrupoDestino}">Grupo</small>
                                                
                                                <div class="text-truncate assunto-responsivo">
                                                    <span class="fw-bold text-dark" th:text="${msg.assunto}">Assunto</span>
                                                    <span th:if="${msg.nomesAnexos != null && msg.nomesAnexos != ''}" class="badge badge-attachment ms-1">
                                                        <i class="fa-solid fa-paperclip"></i>
                                                    </span>
                                                    <span class="text-muted small ms-1 d-none d-sm-inline" th:text="' - ' + ${#strings.abbreviate(msg.conteudo.replaceAll('<[^>]*>', ''), 40)}">Conteúdo...</span>
                                                </div>
                                            </div>
                                        </td>

                                        <td style="width: 120px;" class="text-end pe-2 pe-md-3" onclick="event.stopPropagation()">
                                            
                                            <button th:if="${pastaAtiva == 'ENTRADA'}" 
                                                    class="btn btn-primary btn-sm rounded-pill px-2 px-md-3 fw-bold me-1 shadow-sm"
                                                    onclick="usarModelo(this)" 
                                                    th:data-id="${msg.id}"
                                                    title="Usar este modelo">
                                                <span class="d-none d-md-inline">Usar</span> <i class="fa-solid fa-arrow-right"></i>
                                            </button>

                                            <button th:if="${pastaAtiva != 'LIXEIRA'}" 
                                                    class="btn btn-light btn-sm rounded-circle text-muted hover-danger" 
                                                    th:onclick="'abrirModalLixeira(' + ${msg.id} + ')'" title="Mover para Lixeira">
                                                <i class="fa-regular fa-trash-can"></i>
                                            </button>

                                            <div th:if="${pastaAtiva == 'LIXEIRA'}" class="d-flex justify-content-end gap-2">
                                                <button class="btn btn-light btn-sm rounded-circle text-success" 
                                                        th:onclick="'restaurarMensagem(' + ${msg.id} + ')'" title="Restaurar">
                                                    <i class="fa-solid fa-trash-arrow-up"></i>
                                                </button>
                                                <button class="btn btn-light btn-sm rounded-circle text-danger" 
                                                        th:onclick="'abrirModalExclusaoDefinitiva(' + ${msg.id} + ')'" title="Excluir Definitivamente">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                        </td>

                                        <td class="pe-4 text-end d-none d-md-table-cell" style="width: 100px;">
                                            <span class="small fw-bold text-muted" th:text="${#temporals.format(msg.dataEnvio, 'dd MMM')}">Data</span>
                                        </td>
                                    </tr>
                                    
                                    <tr th:if="${#lists.isEmpty(listaMensagens)}">
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fa-regular fa-folder-open fs-1 mb-3 opacity-25"></i>
                                                <p class="fw-bold mb-0" th:text="${pastaAtiva == 'LIXEIRA'} ? 'Lixeira vazia.' : 'Nenhuma mensagem encontrada.'">Vazio</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card-footer bg-white border-0 py-3" th:if="${totalPaginas > 1}">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Página <span th:text="${paginaAtual + 1}">1</span> de <span th:text="${totalPaginas}">10</span>
                                </small>
                                
                                <nav aria-label="Navegação de páginas">
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item" th:classappend="${paginaAtual == 0} ? 'disabled'">
                                            <a class="page-link rounded-start-pill border-0 bg-light text-dark" 
                                               th:href="@{'/mensagens/caixa/' + ${pastaAtiva}(page=${paginaAtual - 1}, busca=${termoBusca}, comAnexo=${filtroAnexo}, data=${filtroData})}">
                                                <i class="fa-solid fa-chevron-left"></i> Anterior
                                            </a>
                                        </li>
                                        <li class="page-item" th:classappend="${paginaAtual >= totalPaginas - 1} ? 'disabled'">
                                            <a class="page-link rounded-end-pill border-0 bg-light text-dark ms-1" 
                                               th:href="@{'/mensagens/caixa/' + ${pastaAtiva}(page=${paginaAtual + 1}, busca=${termoBusca}, comAnexo=${filtroAnexo}, data=${filtroData})}">
                                                Próximo <i class="fa-solid fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                        </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalNovoModelo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">Novo Modelo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/mensagens/salvarModelo" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categoria (Ex: Boas Vindas)</label>
                            <input type="text" name="categoria" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Assunto</label>
                            <input type="text" name="assunto" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Conteúdo</label>
                            <textarea class="form-control" name="conteudo" rows="6" placeholder="Escreva aqui..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="submit" class="btn btn-primary rounded-pill px-4">Salvar Modelo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLeitura" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content modal-content-custom shadow-lg">
                <div class="modal-header-custom d-flex align-items-center justify-content-between p-3 border-bottom">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width:40px; height:40px; font-weight:bold;" id="modalAvatar">W</div>
                        <div>
                            <h5 class="fw-bold mb-0 text-dark" id="modalAssunto" style="font-size: 1.1rem;">Assunto</h5>
                            <small class="text-muted"><i class="fa-regular fa-calendar-check me-1"></i> <span id="modalData"></span></small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light bg-opacity-25">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="small text-uppercase text-muted fw-bold mb-1">Grupo/Categoria</label>
                            <div><span class="badge bg-white text-primary border rounded-pill px-3 py-2 shadow-sm"><i class="fa-solid fa-users me-2"></i> <span id="modalGrupo"></span></span></div>
                        </div>
                    </div>
                    <div class="message-container bg-white p-3 rounded shadow-sm border mb-4" id="modalConteudo" style="min-height: 100px;"></div>
                    <div id="areaAnexosModal" class="d-none">
                        <h6 class="fw-bold text-dark mb-3"><i class="fa-solid fa-paperclip me-2 text-primary"></i>Anexos</h6>
                        <div id="listaAnexosDownload" class="d-flex flex-wrap gap-3"></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 bg-light"><button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Fechar</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLixeira" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center">
                <div class="modal-body p-4">
                    <h5 class="fw-bold mb-3">Mover para a Lixeira?</h5>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">Não</button>
                        <button type="button" class="btn btn-warning rounded-pill px-3 fw-bold" id="btnConfirmarLixeira">Sim</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalExclusaoDefinitiva" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center">
                <div class="modal-body p-4">
                    <h5 class="fw-bold text-danger mb-1">Excluir Definitivamente?</h5>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger rounded-pill px-3 fw-bold" id="btnConfirmarExclusaoDefinitiva">Excluir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function usarModelo(btn) {
            let id = $(btn).data('id');
            window.location.href = '/mensagens/preparar-envio/' + id;
        }

        function abrirModalCriacao() {
            new bootstrap.Modal(document.getElementById('modalNovoModelo')).show();
        }

        let idSelecionado = null;
        function abrirModalLixeira(id) { 
            idSelecionado = id; 
            new bootstrap.Modal(document.getElementById('modalLixeira')).show(); 
        }
        
        // Listener para confirmar envio para lixeira
        document.getElementById('btnConfirmarLixeira').addEventListener('click', () => { 
            if(idSelecionado) $.post('/mensagens/lixeira/' + idSelecionado, () => location.reload()); 
        });

        function restaurarMensagem(id) { 
            $.post('/mensagens/restaurar/' + id, () => location.reload()); 
        }

        function abrirModalExclusaoDefinitiva(id) { 
            idSelecionado = id; 
            new bootstrap.Modal(document.getElementById('modalExclusaoDefinitiva')).show(); 
        }
        
        // Listener para confirmar exclusão definitiva
        document.getElementById('btnConfirmarExclusaoDefinitiva').addEventListener('click', () => { 
            if(idSelecionado) $.ajax({ url: '/mensagens/excluir/' + idSelecionado, type: 'DELETE', success: () => location.reload() }); 
        });
        
        function toggleAction(id, action, element, type) {
            $.post('/mensagens/' + action + '/' + id, function(state) {
                if(type === 'star') $(element).toggleClass('fa-solid star-active fa-regular');
                if(type === 'flag') $(element).toggleClass('fa-solid flag-active fa-regular');
            });
        }

        function verMensagem(id) {
            $.get("/mensagens/detalhes/" + id, function(data) {
                $('#modalAssunto').text(data.assunto);
                $('#modalConteudo').html(data.conteudo);
                $('#modalGrupo').text(data.nomeGrupoDestino);
                $('#modalAvatar').text(data.nomeGrupoDestino ? data.nomeGrupoDestino.charAt(0).toUpperCase() : 'W');
                if (data.dataEnvio) {
                    const dt = new Date(data.dataEnvio);
                    $('#modalData').text(dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString());
                }
                
                $('#areaAnexosModal').addClass('d-none'); 
                
                new bootstrap.Modal(document.getElementById('modalLeitura')).show();
            });
        }
    </script>
</body>
</html>