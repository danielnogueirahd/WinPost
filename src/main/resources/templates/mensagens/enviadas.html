<!DOCTYPE html>
<html xmlns:th="https://thymeleaf.org">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caixa de Mensagens | WinPost</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/css/estilo.css">

<style>
    /* AJUSTE DE LAYOUT GERAL */
    body {
        padding-top: 80px;
        background-color: #f8f9fa;
    }

    /* HEADER DA PÁGINA */
    .page-header-actions {
        background: #ffffff;
        padding: 1.25rem 1.5rem;
        border-radius: 16px;
        border: 1px solid #eef2f5;
        box-shadow: 0 2px 12px rgba(0,0,0,0.02);
        margin-bottom: 2rem;
    }

    /* BARRA DE PESQUISA MODERNA */
    .search-modern .form-control {
        background-color: #f1f3f5;
        border: 1px solid transparent;
        border-radius: 50px;
        padding-left: 2.5rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }
    
    .search-modern .form-control:focus {
        background-color: #ffffff;
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
    }

    .search-modern {
        position: relative;
        width: 100%;
        max-width: 350px;
    }

    .search-modern .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
        z-index: 5;
        pointer-events: none;
    }

    /* SIDEBAR STICKY */
    .sidebar-sticky {
        position: sticky;
        top: 100px;
        height: calc(100vh - 100px);
        overflow-y: auto;
    }

    /* CARDS DE MODELO */
    .card-modelo {
        border: 1px solid #f0f2f5;
        transition: all 0.2s ease;
    }
    .card-modelo:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.08) !important;
        border-color: #e0e4e8;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* MODAL CLEAN */
    .modal-header-clean {
        background-color: #fff;
        border-bottom: 1px solid #f0f2f5;
        padding: 1.5rem;
    }
    .form-label-small {
        font-size: 0.8rem;
        font-weight: 700;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Cursor Pointer para ícones de ação */
    .action-icon {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .action-icon:hover {
        transform: scale(1.2);
    }

    @media (max-width: 991.98px) {
        body { padding-top: 100px; }
        .sidebar-sticky { position: static; height: auto; }
        .page-header-actions { flex-direction: column; align-items: stretch; }
        .search-modern { max-width: 100%; }
    }
</style>
</head>

<body class="d-flex flex-column min-vh-100">

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="flex-grow-1">
        
        <div class="container-fluid px-3 px-lg-5 mb-5"> 
            
            <div class="d-lg-none mb-4">
                <div class="d-grid mb-3">
                    <a href="/grupos/gerenciar" class="btn btn-primary rounded-pill shadow-sm py-2 fw-bold">
                        <i class="fa-solid fa-pen me-2"></i>Nova Mensagem
                    </a>
                </div>
                
                <div class="d-flex gap-2 overflow-auto pb-2 mobile-nav-scroll">
                    <a href="/mensagens/caixa/ENTRADA" class="btn btn-sm rounded-pill fw-bold text-nowrap" 
                       th:classappend="${pastaAtiva == 'ENTRADA'} ? 'btn-primary' : 'btn-white border bg-white'">
                        <i class="fa-solid fa-folder-open me-1"></i> Modelos
                    </a>
                    <a href="/mensagens/caixa/ENVIADAS" class="btn btn-sm rounded-pill fw-bold text-nowrap" 
                       th:classappend="${pastaAtiva == 'ENVIADAS'} ? 'btn-success text-white' : 'btn-white border bg-white'">
                        <i class="fa-regular fa-paper-plane me-1"></i> Enviadas
                    </a>
                    <a href="/mensagens/caixa/LIXEIRA" class="btn btn-sm rounded-pill fw-bold text-nowrap" 
                       th:classappend="${pastaAtiva == 'LIXEIRA'} ? 'btn-danger text-white' : 'btn-white border bg-white'">
                        <i class="fa-regular fa-trash-can me-1"></i> Lixeira
                    </a>
                </div>
            </div>

            <div class="row g-4">
                
                <div class="col-lg-3 col-xl-2 d-none d-lg-block">
                    <div class="sidebar-sticky">
                        <div class="d-grid mb-4">
                            <a href="/grupos/gerenciar" class="btn btn-primary btn-lg rounded-pill fw-bold shadow-sm">
                                <i class="fa-solid fa-pen me-2"></i>Escrever
                            </a>
                        </div>
                        
                        <div class="list-group list-group-flush bg-transparent">
                            <a href="/mensagens/caixa/ENTRADA" class="list-group-item list-group-item-action bg-transparent border-0 rounded-3 mb-1 px-3 py-2 fw-bold"
                               th:classappend="${pastaAtiva == 'ENTRADA'} ? 'bg-primary bg-opacity-10 text-primary' : 'text-secondary'">
                                <i class="fa-solid fa-folder-open me-3"></i> Modelos
                                <span class="badge bg-primary rounded-pill float-end" th:if="${cntEntrada > 0}" th:text="${cntEntrada}"></span>
                            </a>
                            <a href="/mensagens/caixa/ENVIADAS" class="list-group-item list-group-item-action bg-transparent border-0 rounded-3 mb-1 px-3 py-2 fw-bold"
                               th:classappend="${pastaAtiva == 'ENVIADAS'} ? 'bg-success bg-opacity-10 text-success' : 'text-secondary'">
                                <i class="fa-regular fa-paper-plane me-3"></i> Enviadas
                                <span class="badge bg-success rounded-pill float-end" th:if="${cntEnviadas > 0}" th:text="${cntEnviadas}"></span>
                            </a>
                            <a href="/mensagens/caixa/FAVORITOS" class="list-group-item list-group-item-action bg-transparent border-0 rounded-3 mb-1 px-3 py-2 fw-bold"
                               th:classappend="${pastaAtiva == 'FAVORITOS'} ? 'bg-warning bg-opacity-10 text-warning' : 'text-secondary'">
                                <i class="fa-regular fa-star me-3"></i> Favoritos
                            </a>
                            <a href="/mensagens/caixa/IMPORTANTE" class="list-group-item list-group-item-action bg-transparent border-0 rounded-3 mb-1 px-3 py-2 fw-bold"
                               th:classappend="${pastaAtiva == 'IMPORTANTE'} ? 'bg-info bg-opacity-10 text-info' : 'text-secondary'">
                                <i class="fa-solid fa-bookmark me-3"></i> Importante
                            </a>
                            <a href="/mensagens/caixa/LIXEIRA" class="list-group-item list-group-item-action bg-transparent border-0 rounded-3 mt-3 px-3 py-2 fw-bold"
                               th:classappend="${pastaAtiva == 'LIXEIRA'} ? 'bg-danger bg-opacity-10 text-danger' : 'text-secondary'">
                                <i class="fa-regular fa-trash-can me-3"></i> Lixeira
                                <span class="badge bg-danger rounded-pill float-end" th:if="${cntLixeira > 0}" th:text="${cntLixeira}"></span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9 col-xl-10">
                    
                    <div class="page-header-actions d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="icon-box me-3 p-2 bg-primary bg-opacity-10 rounded-circle d-none d-sm-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                <i th:if="${pastaAtiva == 'ENTRADA'}" class="fa-solid fa-swatchbook text-dark fs-5"></i>
                                <i th:if="${pastaAtiva == 'ENVIADAS'}" class="fa-regular fa-paper-plane text-dark fs-5"></i>
                                <i th:if="${pastaAtiva == 'LIXEIRA'}" class="fa-regular fa-trash-can text-dark fs-5"></i>
                                <i th:if="${pastaAtiva == 'FAVORITOS'}" class="fa-solid fa-star text-dark fs-5"></i>
                                <i th:if="${pastaAtiva == 'IMPORTANTE'}" class="fa-solid fa-bookmark text-dark fs-5"></i>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-0 text-dark">
                                    <span th:if="${pastaAtiva == 'ENTRADA'}">Meus Modelos</span>
                                    <span th:if="${pastaAtiva == 'ENVIADAS'}">Enviadas</span>
                                    <span th:if="${pastaAtiva == 'LIXEIRA'}">Lixeira</span>
                                    <span th:if="${pastaAtiva == 'FAVORITOS'}">Favoritos</span>
                                    <span th:if="${pastaAtiva == 'IMPORTANTE'}">Importante</span>
                                </h4>
                                <small class="text-muted" th:if="${totalPaginas > 0}">
                                    <span th:text="${totalItens}">0</span> registros encontrados
                                </small>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2 flex-grow-1 justify-content-end">
                            <form th:action="@{'/mensagens/caixa/' + ${pastaAtiva}}" method="get" class="search-modern">
                                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                                <input type="text" name="busca" class="form-control" placeholder="Pesquisar..." th:value="${termoBusca}">
                            </form>

                            <button th:if="${pastaAtiva == 'ENTRADA'}" 
                                    class="btn btn-primary d-flex align-items-center gap-2 px-3 py-2 rounded-pill fw-bold shadow-sm ms-2" 
                                    onclick="abrirModalCriacao()">
                                <i class="fa-solid fa-plus"></i>
                                <span class="d-none d-md-inline">Novo</span>
                            </button>
                        </div>
                    </div>

                    <div th:if="${pastaAtiva == 'ENTRADA'}" class="row g-4">
                        <div class="col-md-6 col-xl-4" th:each="msg : ${listaMensagens}">
                            <div class="card h-100 card-modelo border-0 shadow-sm rounded-4">
                                <div class="card-body p-4 d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <span class="badge bg-primary bg-opacity-10 text-white rounded-pill px-3 py-2 small fw-bold">
                                            <i class="fa-solid fa-tag me-1"></i> <span th:text="${msg.nomeGrupoDestino}">Categoria</span>
                                        </span>
                                        
                                        <div class="dropdown">
                                            <button class="btn btn-light btn-sm rounded-circle text-muted" type="button" data-bs-toggle="dropdown">
                                                <i class="fa-solid fa-ellipsis-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                                                <li><a class="dropdown-item small" href="#" th:onclick="'toggleAction(' + ${msg.id} + ', \'favoritar\', this, \'star\')'"><i class="fa-regular fa-star me-2"></i>Favoritar</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item small text-danger" href="#" th:onclick="'abrirModalLixeira(' + ${msg.id} + ')'"><i class="fa-regular fa-trash-can me-2"></i>Mover para Lixeira</a></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <h5 class="fw-bold text-dark mb-2 text-truncate" th:text="${msg.assunto}">Assunto</h5>
                                    
                                    <div class="text-muted small flex-grow-1 mb-4 line-clamp-3" th:text="${msg.conteudo.replaceAll('<[^>]*>', '')}">
                                        Prévia do conteúdo...
                                    </div>

                                    <div class="mt-auto pt-3 border-top">
                                        <button class="btn btn-outline-primary w-100 rounded-pill fw-bold" onclick="usarModelo(this)" th:data-id="${msg.id}">
                                            <i class="fa-solid fa-pen-nib me-2"></i>Usar Modelo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12" th:if="${#lists.isEmpty(listaMensagens)}">
                            <div class="text-center py-5 bg-white rounded-4 border border-dashed">
                                <div class="mb-3">
                                    <span class="bg-light p-4 rounded-circle d-inline-block text-muted">
                                        <i class="fa-solid fa-layer-group fs-1 opacity-25"></i>
                                    </span>
                                </div>
                                <h5 class="fw-bold text-dark">Nenhum modelo encontrado</h5>
                                <p class="text-muted small mb-4">Crie modelos de mensagens para agilizar seus envios futuros.</p>
                                <button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="abrirModalCriacao()">
                                    <i class="fa-solid fa-plus me-1"></i> Criar Primeiro Modelo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div th:unless="${pastaAtiva == 'ENTRADA'}" class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-secondary small text-uppercase">
                                    <tr>
                                        <th class="ps-4 py-3 border-0" style="width: 80px;"></th>
                                        <th class="py-3 border-0 fw-bold" style="width: 20%;">Destino</th>
                                        <th class="py-3 border-0 fw-bold">Assunto / Mensagem</th>
                                        <th class="text-end pe-4 py-3 border-0 fw-bold" style="width: 20%;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="msg : ${listaMensagens}" class="cursor-pointer" th:onclick="'verMensagem(' + ${msg.id} + ')'">
                                        
                                        <td class="ps-4" onclick="event.stopPropagation()">
                                            <div class="d-flex gap-2">
                                                <i class="fa-star action-icon fs-6" 
                                                   th:classappend="${msg.favorito} ? 'fa-solid text-warning' : 'fa-regular text-muted'"
                                                   th:onclick="'toggleAction(' + ${msg.id} + ', \'favoritar\', this, \'star\')'"
                                                   title="Favoritar"></i>
                                                
                                                <i class="fa-bookmark action-icon fs-6"
                                                   th:classappend="${msg.importante} ? 'fa-solid text-info' : 'fa-regular text-muted'"
                                                   th:onclick="'toggleAction(' + ${msg.id} + ', \'importante\', this, \'flag\')'"
                                                   title="Marcar como Importante"></i>
                                            </div>
                                        </td>

                                        <td>
                                            <span class="fw-bold text-primary" th:text="${msg.nomeGrupoDestino}">Grupo</span>
                                        </td>
                                        <td>
                                            <div class="fw-bold text-dark text-truncate" style="max-width: 350px;" th:text="${msg.assunto}">Assunto</div>
                                            <small class="text-muted text-truncate d-block" style="max-width: 350px;" th:text="${#strings.abbreviate(msg.conteudo.replaceAll('<[^>]*>', ''), 60)}">Conteúdo...</small>
                                        </td>
                                        
                                        <td class="text-end pe-4" onclick="event.stopPropagation()">
                                            <div class="d-flex justify-content-end align-items-center gap-3">
                                                
                                                <div class="text-end me-2">
                                                    <div th:text="${#temporals.format(msg.dataEnvio, 'dd MMM')}" class="text-dark small fw-bold">Data</div>
                                                    <div th:text="${#temporals.format(msg.dataEnvio, 'HH:mm')}" class="text-xs text-muted opacity-75">Hora</div>
                                                </div>

                                                <div th:if="${pastaAtiva != 'LIXEIRA'}">
                                                    <button type="button" class="btn btn-light btn-sm rounded-circle text-muted hover-danger shadow-sm border" 
                                                            th:onclick="'abrirModalLixeira(' + ${msg.id} + ')'" title="Mover para Lixeira">
                                                        <i class="fa-regular fa-trash-can"></i>
                                                    </button>
                                                </div>

                                                <div th:if="${pastaAtiva == 'LIXEIRA'}" class="d-flex gap-2">
                                                    <button type="button" class="btn btn-light btn-sm rounded-circle text-success shadow-sm border" 
                                                            th:onclick="'restaurarMensagem(' + ${msg.id} + ')'" title="Restaurar">
                                                        <i class="fa-solid fa-trash-arrow-up"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light btn-sm rounded-circle text-danger shadow-sm border" 
                                                            th:onclick="'abrirModalExclusaoDefinitiva(' + ${msg.id} + ')'" title="Excluir Definitivamente">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(listaMensagens)}">
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="fa-regular fa-folder-open fs-2 mb-2 opacity-25 d-block"></i>
                                            Nenhum registro encontrado.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-center" th:if="${totalPaginas > 1}">
                        <nav>
                            <ul class="pagination pagination-sm shadow-sm">
                                <li class="page-item" th:classappend="${paginaAtual == 0} ? 'disabled'">
                                    <a class="page-link border-0 bg-white text-dark rounded-start-pill px-3" th:href="@{'/mensagens/caixa/' + ${pastaAtiva}(page=${paginaAtual - 1})}">
                                        <i class="fa-solid fa-chevron-left me-1"></i> Anterior
                                    </a>
                                </li>
                                <li class="page-item disabled px-2 d-flex align-items-center">
                                    <span class="small text-muted" th:text="'Pág ' + (${paginaAtual} + 1) + ' de ' + ${totalPaginas}">1 de 1</span>
                                </li>
                                <li class="page-item" th:classappend="${paginaAtual >= totalPaginas - 1} ? 'disabled'">
                                    <a class="page-link border-0 bg-white text-dark rounded-end-pill px-3" th:href="@{'/mensagens/caixa/' + ${pastaAtiva}(page=${paginaAtual + 1})}">
                                        Próximo <i class="fa-solid fa-chevron-right ms-1"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalNovoModelo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <div class="modal-header-clean">
                    <h5 class="modal-title fw-bold text-dark"><i class="fa-solid fa-wand-magic-sparkles text-primary me-2"></i>Novo Modelo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/mensagens/salvarModelo" method="post">
                    <div class="modal-body p-4">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label class="form-label-small">Categoria</label>
                                <input type="text" name="categoria" class="form-control bg-light" placeholder="Ex: Promoção, Aviso..." required>
                            </div>
                            <div class="col-md-7">
                                <label class="form-label-small">Assunto do E-mail</label>
                                <input type="text" name="assunto" class="form-control bg-light" placeholder="Assunto que aparecerá para o cliente" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label-small">Conteúdo da Mensagem</label>
                                <textarea name="conteudo" class="form-control bg-light" rows="8" placeholder="Escreva o corpo da mensagem aqui..." required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-top-0 px-4 pb-4">
                        <button type="button" class="btn btn-light rounded-pill px-4 fw-bold text-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">
                            <i class="fa-solid fa-check me-2"></i>Salvar Modelo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLeitura" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-bottom-0 pb-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold" id="modalAssunto">Assunto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="px-4 pb-2 pt-1">
                    <span class="badge bg-light text-dark border">Modelo Salvo</span>
                </div>
                <div class="modal-body p-4">
                    <div class="bg-light rounded-3 p-4 border" id="modalConteudo" style="min-height: 150px;"></div>
                </div>
                <div class="modal-footer border-top-0 px-4 pb-4">
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLixeira" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center">
                <div class="modal-body p-4">
                    <div class="mb-3 text-warning"><i class="fa-solid fa-triangle-exclamation fs-1"></i></div>
                    <h6 class="fw-bold mb-3">Mover para a Lixeira?</h6>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">Não</button>
                        <button type="button" class="btn btn-warning rounded-pill px-3 fw-bold text-dark" id="btnConfirmarLixeira">Sim</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalExclusaoDefinitiva" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 text-center">
                <div class="modal-body p-4">
                    <div class="mb-3 text-danger"><i class="fa-solid fa-trash-can fs-1"></i></div>
                    <h6 class="fw-bold text-danger mb-1">Excluir para sempre?</h6>
                    <p class="small text-muted">Essa ação não pode ser desfeita.</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger rounded-pill px-3 fw-bold" id="btnConfirmarExclusaoDefinitiva">Excluir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- FUNÇÕES GERAIS ---
        function usarModelo(btn) {
            window.location.href = '/mensagens/preparar-envio/' + $(btn).data('id');
        }
        function abrirModalCriacao() {
            new bootstrap.Modal(document.getElementById('modalNovoModelo')).show();
        }
        function verMensagem(id) {
            $.get("/mensagens/detalhes/" + id, function(data) {
                $('#modalAssunto').text(data.assunto);
                $('#modalConteudo').html(data.conteudo);
                new bootstrap.Modal(document.getElementById('modalLeitura')).show();
            });
        }

        // [ALTERAÇÃO 3] FUNÇÃO PARA FAVORITAR/IMPORTANTE
        function toggleAction(id, action, element, type) {
            $.post('/mensagens/' + action + '/' + id, function() {
                if (type === 'star') {
                    $(element).toggleClass('fa-solid text-warning fa-regular text-muted');
                } else if (type === 'flag') {
                    $(element).toggleClass('fa-solid text-info fa-regular text-muted');
                }
            }).fail(function() {
                alert("Erro ao atualizar status.");
            });
        }

        // --- LÓGICA DE EXCLUSÃO ---
        let idSelecionado = null;

        function abrirModalLixeira(id) { 
            idSelecionado = id; 
            new bootstrap.Modal(document.getElementById('modalLixeira')).show(); 
        }
        
        document.getElementById('btnConfirmarLixeira').addEventListener('click', () => { 
            if(idSelecionado) {
                $.post('/mensagens/lixeira/' + idSelecionado, function() {
                    location.reload(); 
                }).fail(function() {
                    alert("Erro ao mover para a lixeira.");
                });
            }
        });

        function restaurarMensagem(id) { 
            $.post('/mensagens/restaurar/' + id, function() {
                location.reload(); 
            });
        }

        function abrirModalExclusaoDefinitiva(id) { 
            idSelecionado = id; 
            new bootstrap.Modal(document.getElementById('modalExclusaoDefinitiva')).show(); 
        }
        
        document.getElementById('btnConfirmarExclusaoDefinitiva').addEventListener('click', () => { 
            if(idSelecionado) {
                $.ajax({
                    url: '/mensagens/excluir/' + idSelecionado,
                    type: 'DELETE',
                    success: function() {
                        location.reload();
                    },
                    error: function() {
                        alert("Erro ao excluir mensagem.");
                    }
                });
            }
        });
    </script>

</body>
</html>